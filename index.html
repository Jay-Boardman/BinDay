<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BinDay AI</title>
    
    <!-- PWA / Mobile Capability -->
    <!-- Embed Manifest as Base64 Data URI -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkJpbkRheSIsCiAgInNob3J0X25hbWUiOiAiQmluRGF5IiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjZmZmZmZmIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8zMTM1LzMxMzU3MTUucG5nIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzMxMzUvMzEzNTcxNS5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=" />
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="BinDay" />
    <meta name="theme-color" content="#ffffff" />
    
    <!-- Icon for iOS Home Screen -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    
    <!-- Babel for JSX/TSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
        overscroll-behavior-y: none;
      }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
  }
}
</script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-presets="react,typescript">
      import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { Send, Sparkles, Bot, User, X, Calendar, Settings as SettingsIcon, Bell, CalendarPlus, Clock, Moon, Sun, Settings2, BellRing } from 'https://esm.sh/lucide-react@0.344.0';
      import { GoogleGenAI } from 'https://esm.sh/@google/genai@0.1.0';

      // --- CONFIGURATION ---
      // PASTE YOUR API KEY BELOW
      window.process = { 
        env: { 
          API_KEY: AIzaSyBgaZSHDm-S1RweQdTA-oHZ9LoMfMKnI7k 
        } 
      };

      // --- TYPES ---
      enum BinColor {
        Blue = 'Blue',
        Black = 'Black'
      }

      interface ChatMessage {
        id: string;
        role: 'user' | 'model';
        text: string;
        timestamp: number;
      }

      interface ScheduleSettings {
        anchorDate: string;
        anchorBin: BinColor;
        collectionDayOfWeek: number;
        reminderTime: string;
        darkMode: boolean;
      }

      // --- GEMINI SERVICE ---
      const apiKey = process.env.API_KEY || '';
      // Safe initialization in case key is missing
      const ai = apiKey ? new GoogleGenAI({ apiKey }) : null;

      const getRecyclingAdvice = async (query: string): Promise<string> => {
        if (!ai) {
          return "Please open the index.html file and add your Google Gemini API Key in the configuration section.";
        }

        try {
          const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: query,
            config: {
              systemInstruction: `You are a helpful, concise recycling assistant for a household. 
              The household has two bins: 
              1. Blue Bin (Recyclables like paper, card, tins, plastics).
              2. Black Bin (General Waste/Non-recyclables).
              
              When the user asks about an item, tell them exactly which bin it goes in. 
              If it depends on local rules (like pizza boxes or glass), mention that briefly but give a general recommendation.
              Keep answers short and friendly.`,
            }
          });
          
          return response.text || "I'm not sure about that item. Try checking your local council website.";
        } catch (error) {
          console.error("Gemini API Error:", error);
          return "Sorry, I couldn't reach the recycling brain right now.";
        }
      };

      // --- COMPONENT: BinVisualizer ---
      const BinVisualizer = ({ color, isToday }: { color: BinColor; isToday: boolean }) => {
        const isBlue = color === BinColor.Blue;
        const mainColor = isBlue ? '#3b82f6' : '#1f2937';
        const darkColor = isBlue ? '#1d4ed8' : '#111827';
        const lightColor = isBlue ? '#60a5fa' : '#374151';
        
        return (
          <div className={`relative group transition-all duration-500 transform flex flex-col items-center ${isToday ? 'scale-105' : 'scale-100'}`}>
            <div className="relative w-40 h-52 drop-shadow-2xl filter">
              <svg viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
                <defs>
                  <filter id="inset-shadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feComponentTransfer in="SourceAlpha"><feFuncA type="table" tableValues="1 0" /></feComponentTransfer>
                    <feGaussianBlur stdDeviation="3" />
                    <feOffset dx="3" dy="3" result="offsetblur" />
                    <feFlood floodColor="rgba(0,0,0,0.2)" result="color" />
                    <feComposite in2="offsetblur" operator="in" />
                    <feComposite in2="SourceAlpha" operator="in" />
                    <feMerge><feMergeNode in="SourceGraphic" /><feMergeNode /></feMerge>
                  </filter>
                  <linearGradient id={`grad-${color}`} x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor={darkColor} />
                    <stop offset="20%" stopColor={mainColor} />
                    <stop offset="80%" stopColor={mainColor} />
                    <stop offset="100%" stopColor={darkColor} />
                  </linearGradient>
                </defs>

                <circle cx="40" cy="230" r="18" fill="#111" />
                <circle cx="160" cy="230" r="18" fill="#111" />
                
                <path d="M30 60 L170 60 L165 220 C165 230 155 240 145 240 L55 240 C45 240 35 230 35 220 Z" fill={`url(#grad-${color})`} filter="url(#inset-shadow)" />
                <rect x="25" y="60" width="150" height="10" fill={darkColor} rx="2" />
                <path d="M40 60 L40 40 L160 40 L160 60" fill={darkColor} />
                <path d="M20 40 C20 25 30 15 40 10 L160 10 C170 15 180 25 180 40 L180 60 L20 60 Z" fill={mainColor} stroke={lightColor} strokeWidth="2" />
                <path d="M80 60 L80 55 L120 55 L120 60" fill="none" stroke={darkColor} strokeWidth="3" opacity="0.5" />
                <rect x="50" y="80" width="8" height="140" fill="black" opacity="0.1" rx="4" />
                <rect x="142" y="80" width="8" height="140" fill="black" opacity="0.1" rx="4" />

                <g transform="translate(100, 140)">
                   {isBlue ? (
                     <text x="0" y="5" fontSize="70" textAnchor="middle" dominantBaseline="central" fill="white" fillOpacity="0.9" style={{ filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))', fontFamily: 'sans-serif' }}>â™»</text>
                   ) : (
                     <g transform="scale(1.5) translate(-12, -12)" fill="none" opacity="0.9">
                       <path d="M19 11L19 21C19 22.1046 18.1046 23 17 23H7C5.89543 23 5 22.1046 5 21L5 11" stroke="white" strokeWidth="2" />
                       <path d="M12 23V11" stroke="white" strokeWidth="2" opacity="0.5"/>
                       <path d="M10 5L14 5L15 8L9 8L10 5Z" fill="white"/>
                       <path d="M4 8H20" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                     </g>
                   )}
                </g>
              </svg>

              {isToday && (
                <div className={`absolute inset-0 rounded-3xl opacity-40 blur-2xl -z-10 ${isBlue ? 'bg-blue-400' : 'bg-gray-400'}`}></div>
              )}
            </div>

            <div className="mt-4 text-center">
              <h2 className="text-3xl font-extrabold tracking-tight text-gray-800 dark:text-white transition-colors duration-300">{color} Bin</h2>
              <p className="text-xs text-gray-500 dark:text-gray-400 font-medium uppercase tracking-wider mt-0.5 transition-colors duration-300">
                {isBlue ? 'Recycling Week' : 'General Waste'}
              </p>
              
              {isToday && (
                <span className="mt-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400 animate-pulse border border-green-200 dark:border-green-800 shadow-sm">
                  Put out today!
                </span>
              )}
            </div>
          </div>
        );
      };

      // --- COMPONENT: SettingsModal ---
      const SettingsModal = ({ isOpen, onClose, settings, onSave }) => {
        const [tempSettings, setTempSettings] = useState(settings);
        const [permissionStatus, setPermissionStatus] = useState(Notification.permission);

        if (!isOpen) return null;
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        const requestNotificationPermission = async () => {
          const result = await Notification.requestPermission();
          setPermissionStatus(result);
          if (result === 'granted') {
              new Notification("BinDay AI", { body: "Notifications enabled! We'll remind you the day before collection." });
          }
        };

        const addToGoogleCalendar = () => {
          const dayIndex = tempSettings.collectionDayOfWeek;
          const today = new Date();
          const currentDay = today.getDay();
          let daysUntilReminder = (dayIndex - 1) - currentDay;
          if (daysUntilReminder < 0) daysUntilReminder += 7;
          
          const [hours, minutes] = tempSettings.reminderTime.split(':').map(Number);
          const reminderDate = new Date(today);
          reminderDate.setDate(today.getDate() + daysUntilReminder);
          reminderDate.setHours(hours, minutes, 0, 0); 
          
          const formatTime = (date) => date.toISOString().replace(/-|:|\.\d\d\d/g, "");
          const start = formatTime(reminderDate);
          const end = formatTime(new Date(reminderDate.getTime() + 30 * 60 * 1000));
          
          const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=Put%20The%20Bins%20Out&details=Check%20BinDay&location=Home&dates=${start}/${end}&recur=RRULE:FREQ=WEEKLY`;
          window.open(url, '_blank');
        };

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto border dark:border-gray-700">
              <div className="bg-gray-50 dark:bg-gray-900 px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center sticky top-0 z-10">
                <div className="flex items-center gap-2 text-gray-800 dark:text-white"><SettingsIcon size={20} /><h2 className="font-semibold text-lg">Settings</h2></div>
                <button onClick={onClose} className="text-gray-400 p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><X size={20} /></button>
              </div>
              <div className="p-6 space-y-8">
                <div className="space-y-3">
                   <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Appearance</label>
                   <button onClick={() => setTempSettings({ ...tempSettings, darkMode: !tempSettings.darkMode })} className={`w-full flex items-center justify-between p-3 rounded-xl border ${tempSettings.darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-200 text-gray-800'}`}>
                      <div className="flex items-center gap-3">{tempSettings.darkMode ? <Moon size={18} className="text-blue-400"/> : <Sun size={18} className="text-orange-500"/>}<span className="font-medium text-sm">Dark Mode</span></div>
                      <div className={`w-12 h-6 rounded-full p-1 transition-colors ${tempSettings.darkMode ? 'bg-blue-600' : 'bg-gray-200'}`}><div className={`w-4 h-4 rounded-full bg-white shadow-sm transform transition-transform ${tempSettings.darkMode ? 'translate-x-6' : 'translate-x-0'}`}></div></div>
                   </button>
                </div>
                <div className="space-y-3">
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Collection Day</label>
                  <div className="grid grid-cols-2 gap-2">{daysOfWeek.map((day, idx) => (
                      <button key={day} onClick={() => setTempSettings({ ...tempSettings, collectionDayOfWeek: idx })} className={`px-3 py-2 text-sm rounded-lg border ${tempSettings.collectionDayOfWeek === idx ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-700 text-blue-700 dark:text-blue-300 ring-1 ring-blue-500' : 'bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300'}`}>{day}</button>
                    ))}</div>
                </div>
                <div className="space-y-3">
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Which bin is it <strong>this week</strong>?</label>
                  <div className="grid grid-cols-2 gap-4">
                     <button onClick={() => setTempSettings({ ...tempSettings, anchorBin: BinColor.Blue, anchorDate: new Date().toISOString() })} className={`flex flex-col items-center p-4 rounded-xl border-2 ${tempSettings.anchorBin === BinColor.Blue ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-600 dark:bg-gray-700'}`}><div className="w-8 h-8 bg-blue-500 rounded-full mb-2 border border-blue-400"></div><span className="font-medium text-blue-900 dark:text-blue-100">Blue Bin</span></button>
                     <button onClick={() => setTempSettings({ ...tempSettings, anchorBin: BinColor.Black, anchorDate: new Date().toISOString() })} className={`flex flex-col items-center p-4 rounded-xl border-2 ${tempSettings.anchorBin === BinColor.Black ? 'border-gray-800 bg-gray-100 dark:bg-gray-700' : 'border-gray-200 dark:border-gray-600 dark:bg-gray-700'}`}><div className="w-8 h-8 bg-gray-800 rounded-full mb-2 border border-gray-600"></div><span className="font-medium text-gray-900 dark:text-gray-100">Black Bin</span></button>
                  </div>
                </div>
                <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                  <h3 className="font-medium text-gray-800 dark:text-gray-200 flex items-center gap-2"><Bell size={18} /> Reminders</h3>
                  <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800 space-y-4">
                      <div className="flex items-start justify-between gap-4">
                          <div><p className="text-sm font-medium text-blue-900 dark:text-blue-100">Browser Notifications</p><p className="text-xs text-blue-700 dark:text-blue-300 mt-1">Get alert day before.</p></div>
                          {permissionStatus === 'granted' ? <span className="text-xs font-bold text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded">Active</span> : <button onClick={requestNotificationPermission} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-lg">Enable</button>}
                      </div>
                      <div className="space-y-2 pt-2 border-t border-blue-200 dark:border-blue-800">
                         <label className="flex items-center gap-2 text-sm font-medium text-blue-900 dark:text-blue-200"><Clock size={16} /> Reminder Time</label>
                         <input type="time" value={tempSettings.reminderTime} onChange={(e) => setTempSettings({...tempSettings, reminderTime: e.target.value})} className="block w-full rounded-lg border-blue-200 dark:border-blue-700 p-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white" />
                      </div>
                  </div>
                  <button onClick={addToGoogleCalendar} className="w-full flex items-center justify-center gap-2 p-3 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-medium"><CalendarPlus size={18} /> Add Recurring Calendar Alarm</button>
                </div>
              </div>
              <div className="bg-gray-50 dark:bg-gray-900 px-6 py-4 flex justify-end gap-3 sticky bottom-0 border-t border-gray-100 dark:border-gray-700">
                <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400">Cancel</button>
                <button onClick={() => onSave(tempSettings)} className="px-6 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg">Save Schedule</button>
              </div>
            </div>
          </div>
        );
      };

      // --- COMPONENT: RecycleChat ---
      const RecycleChat = () => {
        const [input, setInput] = useState('');
        const [messages, setMessages] = useState([
          { id: 'welcome', role: 'model', text: 'Which bin? Ask me!', timestamp: Date.now() }
        ]);
        const [isLoading, setIsLoading] = useState(false);
        const messagesEndRef = useRef(null);

        const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        useEffect(() => scrollToBottom(), [messages]);

        const handleSend = async (e) => {
          e.preventDefault();
          if (!input.trim() || isLoading) return;

          const userMsg = { id: Date.now().toString(), role: 'user', text: input, timestamp: Date.now() };
          setMessages(prev => [...prev, userMsg]);
          setInput('');
          setIsLoading(true);

          try {
            const responseText = await getRecyclingAdvice(input);
            const aiMsg = { id: (Date.now() + 1).toString(), role: 'model', text: responseText, timestamp: Date.now() };
            setMessages(prev => [...prev, aiMsg]);
          } catch (error) { console.error(error); } finally { setIsLoading(false); }
        };

        return (
          <div className="flex flex-col h-full bg-white dark:bg-gray-800 rounded-2xl shadow-md overflow-hidden border border-gray-100 dark:border-gray-700 transition-colors duration-300">
            <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-3 text-white flex items-center gap-2 shadow-sm shrink-0">
              <Sparkles size={16} /><h3 className="font-semibold text-sm">Recycling Assistant</h3>
            </div>
            <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50/50 dark:bg-gray-900/50">
              {messages.map((msg) => (
                <div key={msg.id} className={`flex items-start gap-2 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                   <div className={`w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 text-xs ${msg.role === 'model' ? 'bg-teal-100 text-teal-700 dark:bg-teal-900 dark:text-teal-300' : 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300'}`}>{msg.role === 'model' ? <Bot size={14} /> : <User size={14} />}</div>
                   <div className={`max-w-[85%] rounded-2xl px-3 py-2 text-sm leading-relaxed ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-sm' : 'bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-100 rounded-tl-sm shadow-sm'}`}>{msg.text}</div>
                </div>
              ))}
              {isLoading && <div className="flex items-center gap-1 text-gray-400 text-xs ml-9"><span className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span><span className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-75"></span><span className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-150"></span></div>}
              <div ref={messagesEndRef} />
            </div>
            <form onSubmit={handleSend} className="p-2 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 flex gap-2 shrink-0">
              <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="Pizza box..." className="flex-1 bg-gray-100 dark:bg-gray-700 border-0 rounded-xl px-4 py-2 focus:ring-2 focus:ring-teal-500 text-sm text-gray-900 dark:text-white" />
              <button type="submit" disabled={isLoading || !input.trim()} className="bg-teal-600 hover:bg-teal-700 disabled:opacity-50 text-white p-2.5 rounded-xl"><Send size={18} /></button>
            </form>
          </div>
        );
      };

      // --- APP LOGIC ---
      const MS_PER_WEEK = 7 * 24 * 60 * 60 * 1000;

      const getBinForDate = (targetDate, settings) => {
        const anchor = new Date(settings.anchorDate);
        anchor.setHours(0, 0, 0, 0);
        const target = new Date(targetDate);
        target.setHours(0, 0, 0, 0);
        const diffTime = target.getTime() - anchor.getTime();
        const diffWeeks = Math.floor(diffTime / MS_PER_WEEK);
        const isEvenWeek = Math.abs(diffWeeks) % 2 === 0;
        if (isEvenWeek) return settings.anchorBin;
        return settings.anchorBin === BinColor.Blue ? BinColor.Black : BinColor.Blue;
      };

      const getUpcomingSchedule = (settings) => {
        const schedule = [];
        const today = new Date();
        const currentDay = today.getDay(); 
        let daysUntilCollection = settings.collectionDayOfWeek - currentDay;
        if (daysUntilCollection < 0) daysUntilCollection += 7; 
        const nextCollection = new Date(today);
        nextCollection.setDate(today.getDate() + daysUntilCollection);
        const date = new Date(nextCollection);
        const bin = getBinForDate(date, settings);
        return [{ date, bin }];
      };

      function App() {
        const [settings, setSettings] = useState(() => {
          const saved = localStorage.getItem('binSettings');
          if (saved) {
            const parsed = JSON.parse(saved);
            if (!parsed.reminderTime) parsed.reminderTime = "18:00";
            if (parsed.darkMode === undefined) parsed.darkMode = false;
            return parsed;
          }
          return {
            anchorDate: new Date().toISOString(),
            anchorBin: BinColor.Blue,
            collectionDayOfWeek: 5,
            reminderTime: "18:00",
            darkMode: false
          };
        });

        const [isSettingsOpen, setIsSettingsOpen] = useState(false);

        useEffect(() => {
          localStorage.setItem('binSettings', JSON.stringify(settings));
          if (settings.darkMode) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }, [settings]);

        const upcomingSchedule = useMemo(() => getUpcomingSchedule(settings), [settings]);
        const nextBin = upcomingSchedule[0]; 
        const today = new Date();
        const isCollectionDay = today.getDay() === settings.collectionDayOfWeek;
        
        useEffect(() => {
          if (Notification.permission !== 'granted') return;
          const checkAndNotify = () => {
            const nextCollectionDate = new Date(nextBin.date);
            nextCollectionDate.setHours(0,0,0,0);
            const todayDate = new Date();
            const currentHour = todayDate.getHours();
            const currentMinute = todayDate.getMinutes();
            todayDate.setHours(0,0,0,0);
            const [remindHour, remindMinute] = settings.reminderTime.split(':').map(Number);
            const oneDayInMs = 24 * 60 * 60 * 1000;
            const diff = nextCollectionDate.getTime() - todayDate.getTime();
            if (diff === oneDayInMs) {
                const isTime = currentHour > remindHour || (currentHour === remindHour && currentMinute >= remindMinute);
                if (isTime) {
                  const lastNotified = localStorage.getItem('lastNotificationDate');
                  const todayStr = todayDate.toDateString();
                  if (lastNotified !== todayStr) {
                      new Notification(`Bin Reminder`, { body: `Don't forget to put out the ${nextBin.bin} bin tomorrow!` });
                      localStorage.setItem('lastNotificationDate', todayStr);
                  }
                }
            }
          };
          checkAndNotify();
          const intervalId = setInterval(checkAndNotify, 60000);
          return () => clearInterval(intervalId);
        }, [nextBin, settings]);

        return (
          <div className="h-screen flex flex-col bg-gray-50 dark:bg-gray-900 transition-colors duration-300 overflow-hidden">
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} settings={settings} onSave={(newSettings) => { setSettings(newSettings); setIsSettingsOpen(false); }} />
            <header className="flex-none bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 z-30 transition-colors duration-300">
              <div className="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-7 h-7 bg-gradient-to-br from-blue-500 to-teal-400 rounded-lg flex items-center justify-center text-white font-bold shadow-sm text-sm">B</div>
                  <h1 className="text-lg font-bold text-gray-800 dark:text-white tracking-tight">BinDay</h1>
                </div>
                <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-2 p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">{Notification.permission === 'granted' && <span className="w-1.5 h-1.5 bg-green-500 rounded-full"></span>}<Settings2 size={20} /></button>
              </div>
            </header>
            <main className="flex-1 flex flex-col max-w-md mx-auto w-full px-4 pt-4 pb-2 gap-4 overflow-hidden">
              <section className="flex-none flex flex-col items-center justify-center min-h-[180px] shrink-0">
                <div className="text-center mb-2">
                  <h2 className={`text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2 ${isCollectionDay ? 'text-red-500 animate-pulse' : 'text-gray-400 dark:text-gray-500'}`}>{isCollectionDay && <BellRing size={12} />}{isCollectionDay ? 'Collection Day!' : 'Next Collection'}</h2>
                  <div className="flex flex-col items-center">
                     <span className="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight leading-tight transition-colors duration-300">{nextBin.date.toLocaleDateString('en-US', { weekday: 'long' })}</span>
                     <span className="text-sm text-gray-500 dark:text-gray-400 font-medium transition-colors duration-300">{nextBin.date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</span>
                  </div>
                </div>
                <div className="transform scale-90 sm:scale-100 origin-center"><BinVisualizer color={nextBin.bin} isToday={isCollectionDay} /></div>
              </section>
              <section className="flex-1 min-h-0 relative flex flex-col"><RecycleChat /></section>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
